# Система обнаружения и классификации медицинских масок

Система для обнаружения лиц и классификации правильности ношения медицинских масок в реальном времени с веб-интерфейсом и REST API.

---

## Описание

Эта система использует компьютерное зрение и машинное обучение для автоматического обнаружения лиц в видеопотоке и классификации правильности ношения медицинских масок. Система поддерживает три класса классификации:

- **Маска надета правильно** (зеленый цвет рамки)
- **Маска надета неправильно** (желтый цвет рамки)  
- **Маска отсутствует** (красный цвет рамки)

---

## Особенности

- **Детектирование в реальном времени**: Обнаружение лиц с использованием MediaPipe Face Mesh и классификация состояния масок
- **Многоформатный вывод**: Поддержка JPEG потокового видео и Base64 кодированных изображений для веб-приложений
- **Управление камерами**: Автоматическое обнаружение доступных камер и возможность переключения между ними во время работы
- **Сглаживание боксов**: Алгоритм трекинга для стабильного отображения ограничивающих рамок на последовательных кадрах
- **REST API**: Полный набор API эндпоинтов для интеграции с другими системами
- **Веб-интерфейс**: Интуитивный интерфейс для просмотра видеопотока и управления системой
- **Обучение модели**: Скрипт для обучения и дообучения классификационной модели на пользовательских данных

---

## Архитектура системы

### Компоненты

1. **webApp.py** - Основное FastAPI приложение с управлением жизненным циклом
2. **api.py** - REST API эндпоинты для взаимодействия с системой  
3. **camera.py** - Менеджер захвата видео и управления камерами
4. **enhanced_mask_detector.py** - Детектор лиц и классификатор масок
5. **augment_train_improved_masks_pytorch.py** - Система обучения модели классификации

### Модель классификации

- **Нейронная сеть**: Многослойный перцептрон с архитектурой 119 → 512 → 256 → 128 → 64 → 32 → 3
- **Извлечение признаков**: 119 признаков на основе цветовых гистограмм, текстурных характеристик и пространственного распределения цветов
- **Сглаживание**: Временное сглаживание предсказаний для устранения флуктуаций

---

## Установка

### Требования

- Python 3.8 или новее
- Веб-камера
- CUDA-совместимая видеокарта (опционально, для ускорения инференса)


###  Настройка
Клонируйте репозиторий

Установите зависимости из requirements-inference.txt

Запустите веб-приложение

###  Использование
**Запуск веб-приложения**

python webApp.py

Приложение будет доступно по адресу: http://127.0.0.1:8000

###  API Эндпоинты
GET / - Веб-интерфейс системы

GET /api/current_frame - Получение текущего кадра в формате JPEG

GET /api/current_frame64 - Получение текущего кадра в формате Base64

GET /api/status - Получение статуса системы и списка доступных камер

POST /api/switch_camera - Переключение на другую камеру

POST /api/reset_tracks - Сброс данных трекинга

##  Обучение модели
### Поддерживаемые датасеты
Система поддерживает два формата датасетов:

1. Формат с XML аннотациями:

Папка images/ с изображениями

Папка annotations/ с XML файлами в формате PASCAL VOC

Классы: with_mask, without_mask, mask_weared_incorrect

2. Папочный формат:

Папка dataset/ содержащая подпапки:

with_mask/ - изображения с правильно надетыми масками

without_mask/ - изображения без масок

incorrect_mask/ или mask_incorrect/ - изображения с неправильно надетыми масками

### Методы аугментации данных
Горизонтальное отражение

Изменение яркости (4 уровня)

Сдвиг цветов (4 уровня)

Поворот (2 угла)

Добавление шума

Масштабирование (2 уровня)

### Параметры обучения
Архитектура модели: 5-слойный MLP с Dropout и BatchNorm

Функция потерь: CrossEntropyLoss с весами классов

Оптимизатор: AdamW с weight decay

Планировщик скорости обучения: ReduceLROnPlateau

Ранняя остановка: Паттерн 20 эпох

### Параметры командной строки
**Камера**
--camera N - Номер камеры (0-9)

--list - Показать список доступных камер

**Сглаживание боксов**
--alpha 0.X - Коэффициент сглаживания (0.5-0.9)

--delay N - Задержка между кадрами в миллисекундах (1-100)

--max_age N - Время удержания треков в кадрах (3-30)

--min_iou 0.X - Порог IoU для сопоставления (0.1-0.5)

**Разрешение видео**
--width N - Ширина кадра (320-1920)

--height N - Высота кадра (240-1080)

--fps N - Частота кадров (10-60)

### Технические детали
**Извлечение признаков**
Система извлекает 119 признаков из каждого обнаруженного лица:

Цветовые гистограммы верхней и нижней частей лица

Гистограммы HSV цветового пространства

Средние значения цветов по регионам

Текстуры через операторы Лапласа и Собеля

Статистики яркости и контраста

**Алгоритм трекинга**
Сопоставление детекций между кадрами по IoU

Экспоненциальное сглаживание координат боксов

Удаление устаревших треков

Автоматическая генерация цветов для классов
